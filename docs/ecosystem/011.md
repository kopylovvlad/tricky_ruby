# How to test code with sequel async_thread_pool

We use Sequel like ORM

```ruby
require 'sequel'

Sequel.extension :fiber_concurrency
Sequel::Model.plugin :async_thread_pool

DB = Sequel.connect(
  adapter:,
  user:,
  password:,
  host:,
  port:,
  database:,
  max_connections:,
  num_async_threads:
)
DB.extension :async_thread_pool
```

and we use `.async`:

- https://github.com/jeremyevans/sequel/blob/5.95.1/lib/sequel/extensions/async_thread_pool.rb
- https://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/async_thread_pool_rb.html

```ruby
model.async.insert({param1: '1', param2: '2'})
```

## How to test it?

1 - use __value

```ruby
def foo
  model.async.insert({param1: '1', param2: '2'})
end

expect(foo.__value).to eq(_)
expect(model.count).to eq(1)
```

2 - mock `.async`

```ruby
allow(model).to receive(:async).and_return(model)
expect(model.count).to eq(1)
```
